<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Control Inteligente de Pérdidas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  margin:0;
  background:#020617;
  color:#e5e7eb;
  font-family:Arial,Helvetica,sans-serif;
}
header {
  padding:16px;
  border-bottom:1px solid #1e293b;
}
main {
  padding:16px;
}
select, button {
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155;
  padding:10px;
  border-radius:6px;
  margin-right:6px;
}
button { cursor:pointer }
.card {
  background:#020617;
  border:1px solid #1e293b;
  border-radius:8px;
  padding:14px;
  margin-top:14px;
}
.alerta { border-left:6px solid #dc2626 }
.warn { border-left:6px solid #facc15 }
.ok { color:#22c55e }
.error {
  background:#7f1d1d;
  color:#fecaca;
  padding:10px;
  border-radius:6px;
}
</style>
</head>

<body>
<header>
  <h2>Control Inteligente de Pérdidas – RAG & Donaciones</h2>
</header>

<main>
  <select id="dias">
    <option value="7">7 días</option>
    <option value="14">14 días</option>
    <option value="30">30 días</option>
  </select>

  <select id="sector">
    <option value="ALL">Toda la sucursal</option>
  </select>

  <button onclick="generar()">Generar reporte</button>

  <div id="out"></div>
</main>

<script>
const API_URL = "PEGÁ_ACÁ_TU_URL_GOOGLE_SCRIPT";

async function generar() {
  const out = document.getElementById("out");
  out.innerHTML = "Cargando...";

  try {
    const dias = document.getElementById("dias").value;
    const sector = document.getElementById("sector").value;

    const res = await fetch(`${API_URL}?dias=${dias}&sector=${sector}`);
    const data = await res.json();

    if (data.error) {
      out.innerHTML = `<div class="error">${data.error}</div>`;
      return;
    }

    // Cargar sectores dinámicos
    const sel = document.getElementById("sector");
    sel.innerHTML = `<option value="ALL">Toda la sucursal</option>`;
    (data.sectores || []).forEach(s => {
      sel.innerHTML += `<option value="${s}">${s}</option>`;
    });

    let html = `
      <div class="card">
        <strong>Resumen</strong><br>
        Alertas: ${data.resumen.total_alertas}<br>
        Advertencias: ${data.resumen.total_advertencias}
      </div>
    `;

    if (data.alertas.length) {
      html += `<div class="card alerta"><strong>ALERTAS</strong>`;
      data.alertas.forEach(a=>{
        html+=`<p>${a.producto} (${a.sku}) – ${a.cantidad_evento_max} ${a.unidad}</p>`;
      });
      html+=`</div>`;
    }

    if (data.advertencias.length) {
      html += `<div class="card warn"><strong>ADVERTENCIAS</strong>`;
      data.advertencias.forEach(a=>{
        html+=`<p>${a.producto} (${a.sku}) – ${a.cantidad_evento_max} ${a.unidad}</p>`;
      });
      html+=`</div>`;
    }

    if (data.mas_frecuente) {
      html += `
        <div class="card">
          <strong>Producto más frecuente</strong><br>
          ${data.mas_frecuente.producto}
        </div>
      `;
    }

    if (data.mas_rag) {
      html += `
        <div class="card">
          <strong>Producto con más RAG</strong><br>
          ${data.mas_rag.producto}
        </div>
      `;
    }

    out.innerHTML = html;

  } catch (e) {
    out.innerHTML = `<div class="error">${e.message}</div>`;
  }
}
</script>
</body>
</html>