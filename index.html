<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Inteligente de PÃ©rdidas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#0b1220;color:#e5e7eb}
header{padding:16px;background:#020617;border-bottom:1px solid #1e293b}
h1{margin:0;font-size:20px}
main{padding:16px;display:flex;flex-direction:column;gap:14px}
select,button{
  padding:10px;border-radius:8px;
  background:#020617;color:#e5e7eb;border:1px solid #334155
}
button{cursor:pointer}
button:hover{background:#1e293b}
.panel{background:#020617;border:1px solid #1e293b;border-radius:12px;padding:14px}
.alerta{border-left:5px solid #dc2626}
.advertencia{border-left:5px solid #facc15}
.item{margin-top:8px;padding:10px;border-radius:8px;background:#020617;border:1px solid #1e293b}
small{color:#9ca3af}
.error{background:#7f1d1d;padding:10px;border-radius:8px;border-left:5px solid red}
</style>
</head>

<body>

<header>
<h1>Control Inteligente de PÃ©rdidas â€“ RAG & Donaciones</h1>
</header>

<main>

<div class="panel">
  <select id="dias">
    <option value="7">Ãšltimos 7 dÃ­as</option>
    <option value="14">Ãšltimos 14 dÃ­as</option>
    <option value="30">Ãšltimos 30 dÃ­as</option>
    <option value="60">Ãšltimos 60 dÃ­as</option>
    <option value="90">Ãšltimos 90 dÃ­as</option>
    <option value="180">Ãšltimos 6 meses</option>
  </select>

  <select id="sector">
    <option value="ALL">Toda la sucursal</option>
  </select>

  <button onclick="generarReporte()">Generar reporte</button>
</div>

<div id="resultado"></div>

</main>

<script>
/* ===== CONFIG PRODUCCIÃ“N ===== */
const API_URL =
"https://script.google.com/macros/s/AKfycby2zsqYco70CIqQ6Pqonw7ldxMF38_2gru9aCJJ3BwX/exec";

/* ===== CARGA SECTORES ===== */
async function cargarSectores(){
  const res = await fetch(`${API_URL}?dias=7&sector=ALL`);
  const data = await res.json();
  if(data.sectores){
    const sel = document.getElementById("sector");
    data.sectores.forEach(s=>{
      const o=document.createElement("option");
      o.value=s;o.textContent=s;sel.appendChild(o);
    });
  }
}

/* ===== REPORTE ===== */
async function generarReporte(){
  const dias=document.getElementById("dias").value;
  const sector=document.getElementById("sector").value;
  const box=document.getElementById("resultado");

  box.innerHTML="<div class='panel'>Generando reporteâ€¦</div>";

  try{
    const res=await fetch(`${API_URL}?dias=${dias}&sector=${encodeURIComponent(sector)}`);
    const d=await res.json();

    if(d.error){box.innerHTML=`<div class='error'>${d.error}</div>`;return;}

    let h=`<div class='panel'><b>${d.resumen.dias} dÃ­as</b> Â· ${d.resumen.sector}<br>
    ðŸ”´ Alertas: ${d.resumen.total_alertas} | ðŸŸ¡ Advertencias: ${d.resumen.total_advertencias}</div>`;

    if(d.alertas?.length){
      h+=`<div class='panel alerta'><b>ðŸ”´ ALERTAS</b>`;
      d.alertas.forEach(a=>h+=`<div class='item'><b>${a.producto}</b><br>${a.cantidad_evento_max} ${a.unidad}</div>`);
      h+=`</div>`;
    }

    if(d.advertencias?.length){
      h+=`<div class='panel advertencia'><b>ðŸŸ¡ ADVERTENCIAS</b>`;
      d.advertencias.forEach(a=>h+=`<div class='item'><b>${a.producto}</b><br>${a.cantidad_evento_max} ${a.unidad}</div>`);
      h+=`</div>`;
    }

    box.innerHTML=h;
  }catch(e){
    box.innerHTML="<div class='error'>Error real al generar reporte</div>";
  }
}

cargarSectores();
</script>

</body>
</html>
