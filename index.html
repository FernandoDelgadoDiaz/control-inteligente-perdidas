<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control Inteligente de Pérdidas – RAG & Donaciones</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:linear-gradient(180deg,#020617,#020617 60%,#020617);
  color:#e5e7eb;
}
.container{max-width:480px;margin:auto;padding:20px}
h1{font-size:22px;margin-bottom:16px}
select,button{
  width:100%;padding:14px;border-radius:12px;
  border:none;font-size:16px;margin-bottom:12px
}
button{background:#3b82f6;color:#fff;font-weight:600}
.card{
  background:linear-gradient(180deg,#020617,#020617);
  border-radius:16px;padding:16px;margin:12px 0;
  box-shadow:0 10px 30px rgba(0,0,0,.4)
}
.alert{border-left:6px solid #ef4444}
.warn{border-left:6px solid #facc15}
.rank{border-left:6px solid #22c55e}
.title{font-weight:700;margin-bottom:6px}
.muted{opacity:.7;font-size:14px}
</style>
</head>

<body>
<div class="container">

<h1>Control Inteligente de Pérdidas – RAG & Donaciones</h1>

<select id="dias">
  <option value="7">7 días</option>
  <option value="14">14 días</option>
  <option value="30">30 días</option>
  <option value="60">60 días</option>
</select>

<select id="sector">
  <option value="ALL">Toda la sucursal</option>
</select>

<button onclick="generar()">Generar reporte</button>

<div id="out"></div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxakcoust-d-geI214--f4NJy8C_VR0Dm5IYVbE_JRgHnMvE-wnZTSjQdxb3SzeDLICSQ/exec";

function generar(){
  const dias=document.getElementById("dias").value;
  const sector=document.getElementById("sector").value;
  fetch(`${API_URL}?dias=${dias}&sector=${sector}`)
    .then(r=>r.json())
    .then(render);
}

function render(data){
  const out=document.getElementById("out");
  out.innerHTML="";

  if(data.error){
    out.innerHTML=`<div class="card alert">${data.error}</div>`;
    return;
  }

  // sectores
  const sel=document.getElementById("sector");
  if(sel.options.length===1){
    data.sectores.forEach(s=>{
      const o=document.createElement("option");
      o.value=s;o.text=s;sel.appendChild(o);
    });
  }

  // resumen
  out.innerHTML+=`
  <div class="card">
    <div class="title">Resumen (${data.resumen.dias} días)</div>
    Sector: ${data.resumen.sector}<br><br>
    <b>Producto más donado:</b> ${data.mas_donado?.producto||"—"}<br>
    <b>Producto más en RAG (eventos):</b> ${data.mas_rag_eventos?.producto||"—"}<br>
    <b>Producto más en RAG (cantidad):</b> ${data.mas_rag_cantidad?.producto||"—"}
  </div>`;

  // eventos
  data.ranking.forEach(p=>{
    const acumulado=Number(p.acumulado);
    const umbral=10;

    let clase="card";
    if(acumulado>=umbral) clase+=" alert";
    else if(acumulado>=umbral*0.8) clase+=" warn";

    out.innerHTML+=`
    <div class="${clase}">
      <div class="title">${p.producto} (${p.sku})</div>
      Evento máx: 1<br>
      Acumulado: ${acumulado}
    </div>`;
  });

  // ranking correcto
  const rankingOrdenado=[...data.ranking]
    .map(p=>({...p,acumulado:Number(p.acumulado)}))
    .sort((a,b)=>b.acumulado-a.acumulado);

  out.innerHTML+=`
  <div class="card rank">
    <div class="title">Ranking de impacto</div>
    <div class="muted">Ordenado por cantidad total</div>
  </div>`;

  rankingOrdenado.forEach((p,i)=>{
    out.innerHTML+=`
    <div class="card">${i+1}. ${p.producto} – ${p.acumulado}</div>`;
  });
}
</script>
</body>
</html>