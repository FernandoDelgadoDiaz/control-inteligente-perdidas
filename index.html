<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Inteligente de PÃ©rdidas â€“ RAG & Donaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #020617, #020617 40%, #020617);
      color: #e5e7eb;
    }

    header {
      padding: 24px;
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(90deg, #020617, #020617);
    }

    .container {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    select, button {
      background: #020617;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 16px;
    }

    button {
      cursor: pointer;
      background: #1f2937;
    }

    button:hover {
      background: #374151;
    }

    .error {
      background: #3f0d0d;
      border-left: 6px solid #ef4444;
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .section {
      margin-bottom: 28px;
    }

    .section h2 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .card {
      background: #020617;
      border: 1px solid #1f2937;
      border-left: 6px solid transparent;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .alerta {
      border-left-color: #ef4444;
    }

    .advertencia {
      border-left-color: #facc15;
    }

    .muted {
      color: #9ca3af;
      font-size: 14px;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: #6b7280;
      font-size: 14px;
    }
  </style>
</head>

<body>

<header>
  Control Inteligente de PÃ©rdidas â€“ RAG & Donaciones
</header>

<div class="container">

  <div class="controls">
    <select id="dias">
      <option value="7">7 dÃ­as</option>
      <option value="14" selected>14 dÃ­as</option>
      <option value="30">30 dÃ­as</option>
    </select>

    <select id="sector">
      <option value="ALL">Toda la sucursal</option>
    </select>

    <button id="btnGenerar">Generar reporte</button>
  </div>

  <div id="mensaje"></div>

  <!-- RESUMEN -->
  <div id="resumen" class="section"></div>

  <!-- ALERTAS -->
  <div id="alertas" class="section"></div>

  <!-- ADVERTENCIAS -->
  <div id="advertencias" class="section"></div>

  <!-- RANKING -->
  <div id="ranking" class="section"></div>

</div>

<footer>
  Control inteligente Â· Datos en tiempo real
</footer>

<script>
const API = "/.netlify/functions/getEventos";

const btn = document.getElementById("btnGenerar");
const diasSelect = document.getElementById("dias");
const sectorSelect = document.getElementById("sector");

const mensaje = document.getElementById("mensaje");
const resumenDiv = document.getElementById("resumen");
const alertasDiv = document.getElementById("alertas");
const advertenciasDiv = document.getElementById("advertencias");
const rankingDiv = document.getElementById("ranking");

btn.addEventListener("click", cargarReporte);
window.addEventListener("load", cargarSectores);

async function cargarSectores() {
  try {
    const r = await fetch(`${API}?dias=7&sector=ALL`);
    const data = await r.json();

    if (!data.sectores) return;

    data.sectores.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sectorSelect.appendChild(opt);
    });
  } catch {
    mensaje.innerHTML = `<div class="error">No se pudieron cargar los sectores.</div>`;
  }
}

async function cargarReporte() {
  mensaje.innerHTML = "";
  resumenDiv.innerHTML = "";
  alertasDiv.innerHTML = "";
  advertenciasDiv.innerHTML = "";
  rankingDiv.innerHTML = "";

  const dias = diasSelect.value;
  const sector = sectorSelect.value;

  try {
    const r = await fetch(`${API}?dias=${dias}&sector=${sector}`);
    const data = await r.json();

    if (data.error) throw new Error(data.error);

    renderResumen(data);
    renderAlertas(data.alertas);
    renderAdvertencias(data.advertencias);
    renderRanking(data.ranking);

  } catch (err) {
    mensaje.innerHTML = `<div class="error">Error real al generar reporte.</div>`;
  }
}

function renderResumen(data) {
  resumenDiv.innerHTML = `
    <h2>Resumen (${data.resumen.dias} dÃ­as)</h2>
    <div class="card">
      <b>Sector:</b> ${data.resumen.sector}<br>
      <b>Alertas:</b> ${data.resumen.total_alertas}<br>
      <b>Advertencias:</b> ${data.resumen.total_advertencias}<br><br>
      <b>Producto mÃ¡s sonado:</b> ${data.mas_frecuente?.producto || "â€”"}<br>
      <b>MÃ¡s RAG:</b> ${data.mas_rag?.producto || "â€”"}
    </div>
  `;
}

function renderAlertas(lista) {
  if (!lista.length) return;
  alertasDiv.innerHTML = `<h2>ðŸ”´ Alertas</h2>`;
  lista.forEach(p => {
    alertasDiv.innerHTML += cardProducto(p, "alerta");
  });
}

function renderAdvertencias(lista) {
  if (!lista.length) return;
  advertenciasDiv.innerHTML = `<h2>ðŸŸ¡ Advertencias</h2>`;
  lista.forEach(p => {
    advertenciasDiv.innerHTML += cardProducto(p, "advertencia");
  });
}

function renderRanking(lista) {
  if (!lista.length) return;
  rankingDiv.innerHTML = `<h2>ðŸ“Š Ranking de impacto</h2>`;
  lista.forEach((p, i) => {
    rankingDiv.innerHTML += `
      <div class="card">
        <b>#${i + 1} ${p.producto}</b><br>
        SKU: ${p.sku}<br>
        Acumulado: ${p.acumulado} ${p.unidad}<br>
        Evento mÃ¡x: ${p.maxEvento}
      </div>
    `;
  });
}

function cardProducto(p, tipo) {
  return `
    <div class="card ${tipo}">
      <b>${p.producto} (${p.sku})</b><br>
      <span class="muted">${p.motivo}</span><br>
      Evento mÃ¡x: ${p.cantidad_evento_max} ${p.unidad}<br>
      Acumulado perÃ­odo: ${p.cantidad_acumulada_periodo}
    </div>
  `;
}
</script>

</body>
</html>