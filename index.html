<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Inteligente de P√©rdidas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#0f172a;color:#e5e7eb}
header{padding:16px 24px;background:#020617;border-bottom:1px solid #1e293b}
header h1{margin:0;font-size:22px}

main{padding:20px;display:flex;flex-direction:column;gap:16px}

.controls{display:flex;gap:12px;flex-wrap:wrap}
select,button{
  padding:10px;background:#020617;color:#e5e7eb;
  border:1px solid #334155;border-radius:6px
}
button{cursor:pointer}
button:hover{background:#1e293b}

.section{
  background:#020617;
  border-radius:12px;
  padding:16px;
}
.section.red{border-left:6px solid #dc2626}
.section.yellow{border-left:6px solid #f59e0b}

.section-title{
  font-weight:bold;
  font-size:16px;
  margin-bottom:10px;
}

.item{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:10px;
  padding:12px;
  margin-bottom:8px;
}

.muted{color:#94a3b8;font-size:13px}

footer{
  padding:10px;
  text-align:center;
  font-size:12px;
  color:#64748b;
  border-top:1px solid #1e293b
}
</style>
</head>

<body>
<header>
<h1>Control Inteligente de P√©rdidas ‚Äì RAG & Donaciones</h1>
</header>

<main>

<div class="controls">
  <select id="dias">
    <option value="7">7 d√≠as</option>
    <option value="14">14 d√≠as</option>
    <option value="30">30 d√≠as</option>
    <option value="60">60 d√≠as</option>
    <option value="90">90 d√≠as</option>
  </select>

  <select id="sector">
    <option value="ALL">Toda la sucursal</option>
    <option value="CARNICERIA">Carnicer√≠a</option>
    <option value="VERDULERIA">Verduler√≠a</option>
    <option value="FIAMBRES Y LACTEOS">Fiambres y L√°cteos</option>
    <option value="ALMACEN">Almac√©n</option>
  </select>

  <button onclick="generar()">Generar reporte</button>
</div>

<div id="resultado"></div>

</main>

<footer>
Control inteligente ¬∑ Datos en tiempo real
</footer>

<script>
const URL_API =
"https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLinSnPuChMLpmL3HLTh7jyvjRx1e1wfH8tohBdYcJilAIhxFexmJFaDFnUKYR6dtZtdKNcPcDXzUohPZua9NULr_J14K3LIR2IjnOnDiohh0Q38HLTk1LI33BME60E4jgmmDCPrgILNPn9JufNln9Od0WH9iMGi3Y14WDUygyg3M8AsYZuK38Y6jQScEpJk_Iq8d2iK6Kce9kZPeqq8hkebC4pbxrl50OR60as1S1gTGjilX-ROxRKSkKGlMg&lib=MZrD42Mo3kLRTVRl9Hx16jtuNG_C6aXEm";

async function generar(){
  const dias = document.getElementById("dias").value;
  const sector = document.getElementById("sector").value;
  const box = document.getElementById("resultado");

  box.innerHTML = `<div class="section"><span class="muted">Generando reporte‚Ä¶</span></div>`;

  try{
    const res = await fetch(`${URL_API}&dias=${dias}&sector=${encodeURIComponent(sector)}`);
    const data = await res.json();
    box.innerHTML = "";

    box.innerHTML += `
      <div class="section">
        <div class="section-title">üìä Resumen √∫ltimos ${dias} d√≠as</div>
        Alertas: <strong>${data.resumen.total_alertas}</strong> |
        Advertencias: <strong>${data.resumen.total_advertencias}</strong>
      </div>`;

    if(data.alertas.length){
      box.innerHTML += `<div class="section red"><div class="section-title">üî¥ Alertas</div></div>`;
      data.alertas.forEach(p => box.innerHTML += card(p));
    }

    if(data.advertencias.length){
      box.innerHTML += `<div class="section yellow"><div class="section-title">üü° Advertencias</div></div>`;
      data.advertencias.forEach(p => box.innerHTML += card(p));
    }

    if(!data.alertas.length && !data.advertencias.length){
      box.innerHTML += `<div class="section"><span class="muted">‚úî Sin alertas ni advertencias en el per√≠odo.</span></div>`;
    }

    if(data.ranking?.length){
      box.innerHTML += `<div class="section"><div class="section-title">üìà Ranking</div></div>`;
      data.ranking.forEach(p => box.innerHTML += card(p));
    }

    if(data.mas_frecuente){
      box.innerHTML += `<div class="section"><div class="section-title">üîÅ Producto m√°s frecuente</div>${card(data.mas_frecuente)}</div>`;
    }

    if(data.mas_rag){
      box.innerHTML += `<div class="section"><div class="section-title">‚ö†Ô∏è Producto con m√°s RAG</div>${card(data.mas_rag)}</div>`;
    }

  } catch(e){
    box.innerHTML = `<div class="section red">‚ùå Error al generar reporte</div>`;
  }
}

function card(p){
  return `
  <div class="item">
    <strong>${p.producto}</strong> (${p.sku})<br>
    Evento m√°x: ${p.maxEvento || p.cantidad_evento_max} ${p.unidad}<br>
    Acumulado: ${p.acumulado || p.cantidad_acumulada_periodo}
  </div>`;
}
</script>

</body>
</html>