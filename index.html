<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Inteligente de P√©rdidas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#0b1220;color:#e5e7eb}
header{padding:16px;background:#020617;border-bottom:1px solid #1e293b}
h1{margin:0;font-size:20px}
main{padding:16px;display:flex;flex-direction:column;gap:14px}

select,button{
  padding:10px;
  border-radius:8px;
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155
}
button{cursor:pointer}
button:hover{background:#1e293b}

.panel{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:12px;
  padding:14px
}

.alerta{border-left:5px solid #dc2626}
.advertencia{border-left:5px solid #facc15}

.item{
  margin-top:8px;
  padding:10px;
  border-radius:8px;
  background:#020617;
  border:1px solid #1e293b
}

h3{margin:6px 0}
small{color:#9ca3af}

.error{
  background:#7f1d1d;
  padding:10px;
  border-radius:8px;
  border-left:5px solid red
}
</style>
</head>

<body>

<header>
  <h1>Control Inteligente de P√©rdidas ‚Äì RAG & Donaciones</h1>
</header>

<main>

  <div class="panel">
    <select id="dias">
      <option value="7">√öltimos 7 d√≠as</option>
      <option value="14">√öltimos 14 d√≠as</option>
      <option value="30">√öltimos 30 d√≠as</option>
      <option value="60">√öltimos 60 d√≠as</option>
      <option value="90">√öltimos 90 d√≠as</option>
      <option value="180">√öltimos 6 meses</option>
    </select>

    <select id="sector">
      <option value="ALL">Toda la sucursal</option>
    </select>

    <button onclick="generarReporte()">Generar reporte</button>
  </div>

  <div id="resultado"></div>

</main>

<script>
/* ===============================
   CONFIGURACI√ìN PRODUCCI√ìN
   =============================== */
const API_URL =
"https://script.google.com/macros/s/AKfycby2zsqYco70CIqQ6Pqonw7ldxMF38_2gru9aCJJ3BwX/exec";

/* ===============================
   CARGA DE SECTORES
   =============================== */
async function cargarSectores(){
  try{
    const res = await fetch(`${API_URL}?dias=7&sector=ALL`);
    const data = await res.json();

    if(data.sectores && Array.isArray(data.sectores)){
      const select = document.getElementById("sector");
      data.sectores.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        select.appendChild(opt);
      });
    }
  }catch(e){
    console.error("Error cargando sectores", e);
  }
}

/* ===============================
   GENERAR REPORTE
   =============================== */
async function generarReporte(){
  const dias = document.getElementById("dias").value;
  const sector = document.getElementById("sector").value;
  const box = document.getElementById("resultado");

  box.innerHTML = `<div class="panel">Generando reporte‚Ä¶</div>`;

  try{
    const res = await fetch(`${API_URL}?dias=${dias}&sector=${encodeURIComponent(sector)}`);
    const d = await res.json();

    if(d.error){
      box.innerHTML = `<div class="error">${d.error}</div>`;
      return;
    }

    let html = `
      <div class="panel">
        <h3>üìä Resumen</h3>
        <small>${d.resumen.dias} d√≠as ¬∑ ${d.resumen.sector}</small>
        <p>üî¥ Alertas: <strong>${d.resumen.total_alertas}</strong> |
           üü° Advertencias: <strong>${d.resumen.total_advertencias}</strong></p>
      </div>
    `;

    /* ALERTAS */
    if(d.alertas && d.alertas.length){
      html += `<div class="panel alerta"><h3>üî¥ Alertas</h3>`;
      d.alertas.forEach(a=>{
        html += `
          <div class="item">
            <strong>${a.producto}</strong> (${a.sku})<br>
            Evento m√°x: ${a.cantidad_evento_max} ${a.unidad}<br>
            Acumulado: ${a.cantidad_acumulada_periodo}
          </div>
        `;
      });
      html += `</div>`;
    }

    /* ADVERTENCIAS */
    if(d.advertencias && d.advertencias.length){
      html += `<div class="panel advertencia"><h3>üü° Advertencias</h3>`;
      d.advertencias.forEach(a=>{
        html += `
          <div class="item">
            <strong>${a.producto}</strong> (${a.sku})<br>
            Evento m√°x: ${a.cantidad_evento_max} ${a.unidad}<br>
            Acumulado: ${a.cantidad_acumulada_periodo}
          </div>
        `;
      });
      html += `</div>`;
    }

    if((!d.alertas || !d.alertas.length) && (!d.advertencias || !d.advertencias.length)){
      html += `<div class="panel"><small>‚úî Sin alertas ni advertencias en el per√≠odo.</small></div>`;
    }

    /* RANKING */
    if(d.ranking && d.ranking.length){
      html += `<div class="panel"><h3>üìà Ranking del per√≠odo</h3>`;
      d.ranking.forEach(r=>{
        html += `
          <div class="item">
            <strong>${r.producto}</strong> (${r.sku})<br>
            Acumulado: ${r.acumulado} ${r.unidad} ¬∑ Eventos: ${r.eventos}
          </div>
        `;
      });
      html += `</div>`;
    }

    /* M√ÅS FRECUENTE */
    if(d.mas_frecuente){
      html += `
        <div class="panel">
          <h3>üîÅ Producto m√°s frecuente</h3>
          <div class="item">
            ${d.mas_frecuente.producto} (${d.mas_frecuente.sku})<br>
            Eventos: ${d.mas_frecuente.eventos} ¬∑ Acumulado: ${d.mas_frecuente.acumulado}
          </div>
        </div>
      `;
    }

    /* M√ÅS RAG */
    if(d.mas_rag){
      html += `
        <div class="panel">
          <h3>‚ö†Ô∏è Producto con m√°s RAG</h3>
          <div class="item">
            ${d.mas_rag.producto} (${d.mas_rag.sku})<br>
            Veces en RAG: ${d.mas_rag.rag}
          </div>
        </div>
      `;
    }

    box.innerHTML = html;

  }catch(err){
    box.innerHTML = `<div class="error">Error real al generar reporte</div>`;
    console.error(err);
  }
}

/* ===============================
   INIT
   =============================== */
cargarSectores();
</script>

</body>
</html>