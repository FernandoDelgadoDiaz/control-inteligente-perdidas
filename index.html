<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control Inteligente de PÃ©rdidas â€“ RAG & Donaciones</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#020617;
  color:#e5e7eb;
}
.container{max-width:480px;margin:auto;padding:20px}
h1{font-size:22px;margin-bottom:16px}

select,button{
  width:100%;padding:14px;border-radius:12px;
  border:none;font-size:16px;margin-bottom:12px
}
button{background:#3b82f6;color:#fff;font-weight:600}

.card{
  background:#020617;
  border-radius:16px;
  padding:16px;
  margin:12px 0;
  box-shadow:0 10px 30px rgba(0,0,0,.4)
}
.alert{border-left:6px solid #ef4444}
.warn{border-left:6px solid #facc15}

.title{font-weight:700;margin-bottom:6px}
.muted{opacity:.7;font-size:14px}
.section{margin-top:20px}
</style>
</head>

<body>
<div class="container">

<h1>Control Inteligente de PÃ©rdidas â€“ RAG & Donaciones</h1>

<select id="dias">
  <option value="7">7 dÃ­as</option>
  <option value="14">14 dÃ­as</option>
  <option value="30">30 dÃ­as</option>
  <option value="60">60 dÃ­as</option>
</select>

<select id="sector">
  <option value="ALL">Toda la sucursal</option>
</select>

<button onclick="generar()">Generar reporte</button>

<div id="out"></div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxakcoust-d-geI214--f4NJy8C_VR0Dm5IYVbE_JRgHnMvE-wnZTSjQdxb3SzeDLICSQ/exec";

function generar(){
  const dias=document.getElementById("dias").value;
  const sector=document.getElementById("sector").value;
  fetch(`${API_URL}?dias=${dias}&sector=${sector}`)
    .then(r=>r.json())
    .then(render);
}

function render(data){
  const out=document.getElementById("out");
  out.innerHTML="";

  if(data.error){
    out.innerHTML=`<div class="card alert">${data.error}</div>`;
    return;
  }

  // sectores
  const sel=document.getElementById("sector");
  if(sel.options.length===1){
    data.sectores.forEach(s=>{
      const o=document.createElement("option");
      o.value=s;o.text=s;
      sel.appendChild(o);
    });
  }

  // resumen
  out.innerHTML+=`
  <div class="card">
    <div class="title">Resumen (${data.resumen.dias} dÃ­as)</div>
    Sector: ${data.resumen.sector}<br><br>
    <b>Producto mÃ¡s donado:</b> ${data.mas_donado?.producto || "â€”"}<br>
    <b>Producto mÃ¡s en RAG (eventos):</b> ${data.mas_rag_eventos?.producto || "â€”"}<br>
    <b>Producto mÃ¡s en RAG (cantidad):</b> ${data.mas_rag_cantidad?.producto || "â€”"}
  </div>`;

  const alertas=[];
  const advertencias=[];

  data.ranking.forEach(p=>{
    const cant=Number(p.acumulado);
    const umbral=10;

    if(cant>=umbral){
      alertas.push(p);
    }else if(cant>=umbral*0.8){
      advertencias.push(p);
    }
  });

  if(alertas.length){
    out.innerHTML+=`<div class="section title">ðŸ”´ Alertas</div>`;
    alertas.forEach(p=>{
      out.innerHTML+=`
      <div class="card alert">
        <div class="title">${p.producto} (${p.sku})</div>
        Evento mÃ¡x: 1<br>
        Acumulado: ${p.acumulado}
      </div>`;
    });
  }

  if(advertencias.length){
    out.innerHTML+=`<div class="section title">ðŸŸ¡ Advertencias</div>`;
    advertencias.forEach(p=>{
      out.innerHTML+=`
      <div class="card warn">
        <div class="title">${p.producto} (${p.sku})</div>
        Evento mÃ¡x: 1<br>
        Acumulado: ${p.acumulado}
      </div>`;
    });
  }

  // ranking
  const rankingOrdenado=[...data.ranking]
    .map(p=>({...p,acumulado:Number(p.acumulado)}))
    .sort((a,b)=>b.acumulado-a.acumulado);

  out.innerHTML+=`
  <div class="section title">Ranking de impacto</div>
  <div class="muted">Ordenado por cantidad total</div>`;

  rankingOrdenado.forEach((p,i)=>{
    out.innerHTML+=`
    <div class="card">
      ${i+1}. ${p.producto} â€“ ${p.acumulado}
    </div>`;
  });
}
</script>
</body>
</html>