<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Control Inteligente de PÃ©rdidas â€“ RAG & Donaciones</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:linear-gradient(180deg,#020617,#020617 40%,#020617);
  color:#fff;
}
.container{max-width:720px;margin:auto;padding:20px}
h1{font-size:22px;margin-bottom:20px}
select,button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  margin-bottom:12px;
  font-size:16px;
}
button{
  background:#3b82f6;
  color:#fff;
  font-weight:600;
}
.card{
  background:rgba(255,255,255,.06);
  border-radius:16px;
  padding:16px;
  margin-bottom:14px;
}
.badge-red{border-left:6px solid #ef4444}
.badge-yellow{border-left:6px solid #facc15}
.section-title{
  display:flex;
  align-items:center;
  gap:8px;
  margin:20px 0 10px;
  font-weight:700;
}
.rank-item{
  background:rgba(255,255,255,.05);
  padding:12px;
  border-radius:12px;
  margin-bottom:8px;
}
.small{opacity:.85;font-size:14px}
</style>
</head>

<body>
<div class="container">
<h1>Control Inteligente de PÃ©rdidas â€“ RAG & Donaciones</h1>

<select id="dias">
  <option value="7">7 dÃ­as</option>
  <option value="14">14 dÃ­as</option>
  <option value="30">30 dÃ­as</option>
  <option value="60">60 dÃ­as</option>
</select>

<select id="sector">
  <option value="ALL">Toda la sucursal</option>
</select>

<button onclick="generar()">Generar reporte</button>

<div id="resultado"></div>
</div>

<script>
const API_URL = "https://controldeperdidas.netlify.app/.netlify/functions/getEventos";

async function generar(){
  const dias = document.getElementById("dias").value;
  const sector = document.getElementById("sector").value;
  const cont = document.getElementById("resultado");
  cont.innerHTML = "";

  const res = await fetch(`${API_URL}?dias=${dias}&sector=${sector}`);
  const data = await res.json();

  renderResumen(data, dias, sector);
  renderAlertas(data);
  renderAdvertencias(data);
  renderRanking(data);
  cargarSectores(data);
}

function renderResumen(data,dias,sector){
  const r = data.resumen || {};
  const div = document.createElement("div");
  div.className="card";
  div.innerHTML=`
    <strong>Resumen (${dias} dÃ­as)</strong><br>
    Sector: ${sector==="ALL"?"Toda la sucursal":sector}<br><br>

    <strong>Producto mÃ¡s donado:</strong><br>
    ${data.mas_donado ? 
      `${data.mas_donado.producto} (SKU ${data.mas_donado.sku}) â€“ ${data.mas_donado.acumulado}` 
      : "â€”"}<br><br>

    <strong>Producto mÃ¡s en RAG (eventos):</strong><br>
    ${data.mas_rag_eventos ?
      `${data.mas_rag_eventos.producto} (SKU ${data.mas_rag_eventos.sku}) â€“ ${data.mas_rag_eventos.eventos} evento(s)`
      : "â€”"}<br><br>

    <strong>Producto mÃ¡s en RAG (cantidad):</strong><br>
    ${data.mas_rag_cantidad ?
      `${data.mas_rag_cantidad.producto} (SKU ${data.mas_rag_cantidad.sku}) â€“ ${data.mas_rag_cantidad.acumulado}`
      : "â€”"}
  `;
  resultado.appendChild(div);
}

function renderAlertas(data){
  if(!data.ranking) return;
  const alertas = data.ranking.filter(p=>p.acumulado>10);
  if(alertas.length===0) return;

  resultado.innerHTML+=`<div class="section-title">ðŸ”´ Alertas</div>`;
  alertas.forEach(p=>{
    resultado.innerHTML+=`
      <div class="card badge-red">
        <strong>${p.producto}</strong><br>
        SKU: ${p.sku}<br>
        Evento mÃ¡x: 1<br>
        Acumulado: ${p.acumulado}
      </div>`;
  });
}

function renderAdvertencias(data){
  if(!data.ranking) return;
  const adv = data.ranking.filter(p=>p.acumulado<=10);
  if(adv.length===0) return;

  resultado.innerHTML+=`<div class="section-title">ðŸŸ¡ Advertencias</div>`;
  adv.forEach(p=>{
    resultado.innerHTML+=`
      <div class="card badge-yellow">
        <strong>${p.producto}</strong><br>
        SKU: ${p.sku}<br>
        Evento mÃ¡x: 1<br>
        Acumulado: ${p.acumulado}
      </div>`;
  });
}

function renderRanking(data){
  if(!data.ranking || data.ranking.length===0) return;
  resultado.innerHTML+=`
    <div class="section-title">ðŸ“Š Ranking de impacto</div>
    <div class="small">Ordenado por cantidad total</div>`;
  data.ranking.forEach((p,i)=>{
    resultado.innerHTML+=`
      <div class="rank-item">
        ${i+1}. ${p.producto} â€“ ${p.acumulado}
      </div>`;
  });
}

function cargarSectores(data){
  if(!data.sectores) return;
  const sel = document.getElementById("sector");
  sel.innerHTML=`<option value="ALL">Toda la sucursal</option>`;
  data.sectores.forEach(s=>{
    sel.innerHTML+=`<option value="${s}">${s}</option>`;
  });
}
</script>
</body>
</html>
