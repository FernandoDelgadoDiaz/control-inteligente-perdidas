<script>
const URL_GOOGLE_SCRIPT = "https://script.google.com/macros/s/AKfycby4QCiHE9BI496qmBwY7-ZnCFKUSkV1UPBXegu8xAnq18s4kFfgIBLCVaZtum585K6IUQ/exec";

function toggleSector() {
  const toggle = document.getElementById("sectorToggle").value;
  const sector = document.getElementById("sector");
  sector.disabled = toggle !== "one";
}

async function generarReporte() {
  const periodo = document.getElementById("periodo").value;
  const sectorToggle = document.getElementById("sectorToggle").value;
  const sector = document.getElementById("sector").value;
  const box = document.getElementById("resultado");

  box.innerHTML = "";

  if (!periodo) {
    box.innerHTML = "<div class='alert-yellow'>Seleccion√° un per√≠odo.</div>";
    return;
  }

  if (sectorToggle === "one" && !sector) {
    box.innerHTML = "<div class='alert-yellow'>Seleccion√° un sector.</div>";
    return;
  }

  box.innerHTML = `<p>üìä Reporte √∫ltimos <strong>${periodo} d√≠as</strong></p>`;
  box.innerHTML += sectorToggle === "one"
    ? `<p>üìç Sector: <strong>${sector}</strong></p>`
    : `<p>üìç Sector: <strong>Toda la sucursal</strong></p>`;

  try {
    const params = new URLSearchParams({
      dias: periodo,
      sector: sectorToggle === "one" ? sector : "ALL"
    });

    const response = await fetch(`${URL_GOOGLE_SCRIPT}?${params.toString()}`);
    const data = await response.json();

    if (!Array.isArray(data) || data.length === 0) {
      box.innerHTML += "<p class='ok'>‚úî No se detectaron alertas en el per√≠odo.</p>";
      return;
    }

    let alertasRojas = 0;
    let alertasAmarillas = 0;

    data.forEach(item => {
      if (item.tipo === "ROJA") {
        alertasRojas++;
        box.innerHTML += `
          <div class="alert-red">
            üî¥ ${item.descripcion}<br>
            Producto: <strong>${item.producto}</strong><br>
            Cantidad: ${item.cantidad} ${item.unidad}
          </div>`;
      }

      if (item.tipo === "AMARILLA") {
        alertasAmarillas++;
        box.innerHTML += `
          <div class="alert-yellow">
            üü° ${item.descripcion}<br>
            Producto: <strong>${item.producto}</strong>
          </div>`;
      }
    });

    box.innerHTML += `
      <p class="ok">
        ‚úî Reporte generado correctamente.<br>
        üî¥ Alertas cr√≠ticas: ${alertasRojas}<br>
        üü° Alertas preventivas: ${alertasAmarillas}
      </p>
    `;

  } catch (error) {
    box.innerHTML = "<div class='alert-red'>‚ùå Error al obtener datos reales.</div>";
    console.error("Error fetch:", error);
  }
}
</script>