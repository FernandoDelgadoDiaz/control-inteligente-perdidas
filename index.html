<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Inteligente de PÃ©rdidas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
    body { margin:0; background:#0f172a; color:#e5e7eb; }
    header { padding:16px 24px; background:#020617; border-bottom:1px solid #1e293b; }
    header h1 { margin:0; font-size:22px; }
    main { padding:20px; display:flex; flex-direction:column; gap:16px; }

    .controls, .summary {
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    }

    select, button {
      padding:10px; background:#020617; color:#e5e7eb;
      border:1px solid #334155; border-radius:6px;
    }
    button { cursor:pointer; }
    button:hover { background:#1e293b; }

    .card {
      padding:14px; border-radius:8px; min-width:180px;
      background:#020617; border:1px solid #1e293b;
    }
    .red { border-left:6px solid #dc2626; }
    .yellow { border-left:6px solid #f59e0b; }

    .list { display:flex; flex-direction:column; gap:10px; }
    .item {
      padding:12px; border-radius:8px;
      background:#020617; border:1px solid #1e293b;
    }

    footer {
      padding:10px; text-align:center;
      font-size:12px; color:#64748b;
      border-top:1px solid #1e293b;
    }
  </style>
</head>

<body>
<header>
  <h1>Control Inteligente de PÃ©rdidas</h1>
</header>

<main>

  <!-- CONTROLES -->
  <div class="controls">
    <select id="dias">
      <option value="7">7 dÃ­as</option>
      <option value="14">14 dÃ­as</option>
      <option value="30">30 dÃ­as</option>
      <option value="60">60 dÃ­as</option>
      <option value="90">90 dÃ­as</option>
      <option value="180">180 dÃ­as</option>
    </select>

    <select id="sectorToggle" onchange="toggleSector()">
      <option value="ALL">Toda la sucursal</option>
      <option value="ONE">Un sector</option>
    </select>

    <select id="sector" disabled>
      <option value="">Seleccionar sector</option>
      <option>CARNICERIA</option>
      <option>VERDULERIA</option>
      <option>LACTEOS</option>
      <option>FIAMBRES</option>
      <option>CONGELADOS</option>
      <option>PANADERIA</option>
      <option>ALMACEN</option>
      <option>BEBIDAS</option>
      <option>LIMPIEZA</option>
      <option>PERFUMERIA</option>
      <option>NO COMESTIBLES</option>
      <option>TEXTIL</option>
    </select>

    <button onclick="cargarReporte()">Generar reporte</button>
    <button onclick="exportarCSV()">Exportar CSV</button>
  </div>

  <!-- RESUMEN -->
  <div class="summary">
    <div class="card red" id="cntAlertas">ðŸ”´ Alertas: 0</div>
    <div class="card yellow" id="cntAdvert">ðŸŸ¡ Advertencias: 0</div>
    <div class="card" id="histMensual">ðŸ“… HistÃ³rico: â€”</div>
  </div>

  <!-- LISTADO -->
  <div class="list" id="listado"></div>

</main>

<footer>
  Control inteligente Â· Datos en tiempo real
</footer>

<script>
const URL_API = "https://script.google.com/macros/s/AKfycbzZF1QIb9axK7iHoRYHTqM3uX7JuYpjJKyOuPF5F0RJnuCtPeQDwD2xeVxZBONYTy5dxg/exec";

let ultimoReporte = [];

function toggleSector() {
  document.getElementById("sector").disabled =
    document.getElementById("sectorToggle").value !== "ONE";
}

async function cargarReporte() {
  const dias = document.getElementById("dias").value;
  const toggle = document.getElementById("sectorToggle").value;
  const sectorSel = document.getElementById("sector").value;
  const sector = (toggle === "ONE" && sectorSel) ? sectorSel : "ALL";

  const res = await fetch(`${URL_API}?dias=${dias}&sector=${sector}`);
  const data = await res.json();

  document.getElementById("cntAlertas").innerText =
    `ðŸ”´ Alertas: ${data.resumen.total_alertas}`;
  document.getElementById("cntAdvert").innerText =
    `ðŸŸ¡ Advertencias: ${data.resumen.total_advertencias}`;

  // HISTÃ“RICO SIMPLE
  document.getElementById("histMensual").innerText =
    `ðŸ“… Ãšltimos ${dias} dÃ­as`;

  // ORDENAR POR IMPACTO (alertas primero, luego advertencias)
  ultimoReporte = [
    ...data.alertas.map(x => ({...x, nivel:"ALERTA"})),
    ...data.advertencias.map(x => ({...x, nivel:"ADVERTENCIA"}))
  ];

  const box = document.getElementById("listado");
  box.innerHTML = "";

  ultimoReporte.forEach(i => {
    box.innerHTML += `
      <div class="item ${i.nivel === "ALERTA" ? "red" : "yellow"}">
        <strong>${i.producto}</strong> (${i.sku})<br/>
        ${i.nivel} Â· ${i.motivo}<br/>
        Evento mÃ¡x: ${i.cantidad_evento_max} ${i.unidad}<br/>
        Acumulado: ${i.cantidad_acumulada_periodo}
      </div>`;
  });
}

function exportarCSV() {
  if (!ultimoReporte.length) {
    alert("No hay datos para exportar");
    return;
  }

  const headers = [
    "SKU","Producto","Nivel","Motivo",
    "Unidad","Evento_max","Acumulado"
  ];

  const rows = ultimoReporte.map(i => [
    i.sku, i.producto, i.nivel, i.motivo,
    i.unidad, i.cantidad_evento_max, i.cantidad_acumulada_periodo
  ]);

  let csv = headers.join(",") + "\n";
  rows.forEach(r => csv += r.join(",") + "\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "reporte_perdidas.csv";
  link.click();
}
</script>

</body>
</html>